{% extends "base.html" %}

{% block content %}
<div class="cyber-chat-container">
    <!-- Header minimalista -->
    <div class="chat-terminal-header">
        <div class="header-content">
            <div class="header-left">
                <div class="terminal-controls">
                    <span class="control-dot red"></span>
                    <span class="control-dot yellow"></span>
                    <span class="control-dot green"></span>
                </div>
                <h2 class="cyber-chat-title">
                    <i class="fas fa-comment-dots"></i>
                    CHIPI IA
                </h2>
            </div>
            <div class="connection-status">
                <span class="status-indicator"></span>
                <span class="status-text">EN LÍNEA</span>
            </div>
        </div>
    </div>

    <!-- Contenedor de chat simplificado -->
    <div class="cyber-chat-window">
        <!-- Área de mensajes -->
        <div id="chat-messages" class="cyber-messages-container">
            <!-- Mensaje de bienvenida del sistema -->
            <div class="message-system">
                <div class="system-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="system-content">
                    <div class="message-bubble system">
                        <p class="message-sender">Sistema <span class="message-time">• Ahora</span></p>
                        <p class="welcome-message">¡Hola! Soy Chipi, tu asistente virtual. ¿En qué puedo ayudarte hoy?</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indicador de escritura -->
        <div id="typing-indicator" class="cyber-typing-indicator">
            <div class="typing-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="typing-content">
                <div class="typing-bubble">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <p>Chipi está escribiendo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de entrada de mensajes mejorado -->
    <div class="cyber-input-panel">
        <div class="input-container">
            <div class="input-field-wrapper">
                <textarea 
                    id="chat-input" 
                    class="cyber-text-input" 
                    placeholder="Escribe tu mensaje aquí..."
                    rows="1"
                    aria-label="Escribe tu mensaje para Chipi"
                ></textarea>
            </div>
            
            <div class="input-actions">
                <button id="chat-send" class="cyber-send-button" aria-label="Enviar mensaje">
                    <i class="fas fa-paper-plane"></i>
                </button>
                
                <button id="stop-speech" class="cyber-stop-button" aria-label="Detener voz" style="display: none;">
                    <i class="fas fa-stop"></i>
                </button>
            </div>
        </div>

        <!-- Comandos rápidos con mejor diseño -->
        <div class="quick-commands">
            <button class="command-button" data-command="Hola Chipi">
                <i class="fas fa-hand"></i>
                <span>Saludo</span>
            </button>
            <button class="command-button" data-command="Abrir WhatsApp">
                <i class="fab fa-whatsapp"></i>
                <span>WhatsApp</span>
            </button>
            <button class="command-button" data-command="Mis recordatorios">
                <i class="fas fa-bell"></i>
                <span>Recordatorios</span>
            </button>
            <button class="command-button" data-command="Mis contraseñas">
                <i class="fas fa-key"></i>
                <span>Contraseñas</span>
            </button>
        </div>
    </div>
</div>

<script>
class CyberChat {
    constructor() {
        this.messagesContainer = document.getElementById('chat-messages');
        this.input = document.getElementById('chat-input');
        this.sendButton = document.getElementById('chat-send');
        this.stopButton = document.getElementById('stop-speech');
        this.typingIndicator = document.getElementById('typing-indicator');
        
        // Para controlar la escritura progresiva
        this.currentUtterance = null;
        
        this.init();
        this.setupEventListeners();
    }

    init() {
        this.setupAutoResize();
        this.loadInitialHistory();
    }

    setupEventListeners() {
        this.sendButton.addEventListener('click', () => this.sendMessage());
        this.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        this.stopButton.addEventListener('click', () => this.stopSpeech());
        
        // Comandos rápidos
        document.querySelectorAll('.command-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const command = e.currentTarget.getAttribute('data-command');
                this.input.value = command;
                this.input.focus();
            });
        });

        // Ajustar cuando cambia el tamaño de la ventana
        window.addEventListener('resize', () => {
            this.adjustForMobile();
        });
    }

    setupAutoResize() {
        this.input.addEventListener('input', () => {
            this.input.style.height = 'auto';
            this.input.style.height = Math.min(this.input.scrollHeight, 120) + 'px';
        });
    }

    adjustForMobile() {
        // Ajustes específicos para móviles
        if (window.innerWidth <= 768) {
            document.body.classList.add('mobile-chat');
        } else {
            document.body.classList.remove('mobile-chat');
        }
    }

    async sendMessage() {
        const message = this.input.value.trim();
        if (!message) return;

        this.addMessage(message, 'user');
        this.input.value = '';
        this.input.style.height = 'auto';
        
        this.showTypingIndicator();
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message })
            });

            this.hideTypingIndicator();

            if (!response.ok) {
                if (response.status === 401) {
                    this.addSystemMessage('Tu sesión ha expirado. Redirigiendo al inicio de sesión...');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }
                throw new Error('Error del servidor');
            }

            const data = await response.json();
            
            // Mostrar respuesta completa inmediatamente
            this.addMessage(data.response, 'bot');
            
            // Iniciar síntesis de voz si está habilitada
            if (window.speechSynthesis && localStorage.getItem('voiceEnabled') === 'true') {
                this.speakText(data.response);
            }

        } catch (error) {
            this.hideTypingIndicator();
            this.addSystemMessage('Lo siento, ha ocurrido un error. Por favor intenta nuevamente.');
        }
    }

    addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-${sender}`;
        
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div class="message-bubble ${sender}">
                    <p class="message-sender">${sender === 'user' ? 'Tú' : 'Chipi'} <span class="message-time">• ${timestamp}</span></p>
                    <p class="message-text">${this.formatMessage(text)}</p>
                </div>
            </div>
        `;

        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
        
        // Efecto de aparición
        messageDiv.style.opacity = '0';
        setTimeout(() => {
            messageDiv.style.opacity = '1';
        }, 10);
        
        return messageDiv.querySelector('.message-text');
    }

    addSystemMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-system';
        
        messageDiv.innerHTML = `
            <div class="system-avatar">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="system-content">
                <div class="message-bubble system">
                    <p class="message-sender">Sistema <span class="message-time">• Ahora</span></p>
                    <p class="message-text">${text}</p>
                </div>
            </div>
        `;

        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }

    showTypingIndicator() {
        this.typingIndicator.style.display = 'flex';
        this.scrollToBottom();
    }

    hideTypingIndicator() {
        this.typingIndicator.style.display = 'none';
    }

    scrollToBottom() {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
    }

    formatMessage(text) {
        // Convertir URLs en enlaces clickeables
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }

    speakText(text) {
        if ('speechSynthesis' in window) {
            this.stopSpeech();
            
            const cleanText = text.replace(/\*/g, '').replace(/#/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            utterance.lang = 'es-ES';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;

            this.stopButton.style.display = 'block';
            
            utterance.onend = () => {
                this.stopButton.style.display = 'none';
            };

            utterance.onerror = () => {
                this.stopButton.style.display = 'none';
            };

            this.currentUtterance = utterance;
            window.speechSynthesis.speak(utterance);
        }
    }

    stopSpeech() {
        if (window.speechSynthesis) {
            window.speechSynthesis.cancel();
            this.stopButton.style.display = 'none';
        }
    }

    async loadInitialHistory() {
        try {
            const response = await fetch('/api/chat/history?limit=20');
            if (response.ok) {
                const data = await response.json();
                if (data.conversations && data.conversations.length > 0) {
                    data.conversations.forEach(conv => {
                        this.addMessage(conv.user_message, 'user');
                        this.addMessage(conv.bot_response, 'bot');
                    });
                }
            }
        } catch (error) {
            console.error('Error loading initial history:', error);
        }
    }
}

// Inicializar el chat
document.addEventListener('DOMContentLoaded', () => {
    new CyberChat();
});
</script>

<style>
/* Estilos específicos del chat cybernético - REDISEÑADO */
.cyber-chat-container {
    position: relative;
    height: 100vh;
    background: linear-gradient(135deg, var(--cyber-darker) 0%, var(--cyber-dark) 100%);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* Header mejorado */
.chat-terminal-header {
    padding: 1rem;
    background: rgba(10, 14, 23, 0.95);
    border-bottom: 1px solid var(--cyber-primary);
    flex-shrink: 0;
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.terminal-controls {
    display: flex;
    gap: 0.5rem;
}

.control-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.control-dot.red { background: #ff5f57; }
.control-dot.yellow { background: #ffbd2e; }
.control-dot.green { background: #28ca42; }

.cyber-chat-title {
    font-family: 'Orbitron', monospace;
    font-size: 1.2rem;
    color: var(--cyber-primary);
    margin: 0;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    background: var(--cyber-accent);
    border-radius: 50%;
    animation: pulse 1s ease-in-out infinite;
}

.status-text {
    color: var(--cyber-accent);
    font-size: 0.8rem;
    font-weight: 600;
}

/* Ventana de chat */
.cyber-chat-window {
    flex: 1;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.cyber-messages-container {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Estilos de mensajes mejorados */
.message-user,
.message-bot,
.message-system {
    display: flex;
    gap: 0.8rem;
    align-items: flex-start;
    animation: message-appear 0.3s ease-out;
}

.message-user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--cyber-primary), var(--cyber-accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
    font-size: 1rem;
}

.system-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--cyber-neon);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
    font-size: 1rem;
}

.message-content {
    max-width: 85%;
}

.message-bubble {
    padding: 0.8rem 1rem;
    border-radius: 18px;
    position: relative;
    line-height: 1.4;
}

.message-bubble.user {
    background: linear-gradient(135deg, var(--cyber-primary), var(--cyber-accent));
    color: white;
    border-bottom-right-radius: 5px;
}

.message-bubble.bot {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-bottom-left-radius: 5px;
    backdrop-filter: blur(10px);
}

.message-bubble.system {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.2);
    border-radius: 12px;
}

.message-sender {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.3rem;
    opacity: 0.9;
}

.message-text {
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.4;
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.7;
    font-weight: normal;
}

/* Typing indicator */
.cyber-typing-indicator {
    display: none;
    align-items: center;
    gap: 0.8rem;
    padding: 0 1rem 1rem 1rem;
    animation: slide-up 0.3s ease-out;
}

.typing-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--cyber-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
}

.typing-bubble {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.8rem 1rem;
    border-radius: 18px;
    border-bottom-left-radius: 5px;
}

.typing-dots {
    display: flex;
    gap: 0.3rem;
    margin-bottom: 0.4rem;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: var(--cyber-text-secondary);
    border-radius: 50%;
    animation: typing-bounce 1.4s ease-in-out infinite;
}

.typing-dots span:nth-child(1) { animation-delay: 0s; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

.typing-bubble p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--cyber-text-secondary);
}

/* Panel de entrada */
.cyber-input-panel {
    background: rgba(10, 14, 23, 0.95);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem;
    flex-shrink: 0;
}

.input-container {
    display: flex;
    gap: 0.8rem;
    align-items: flex-end;
    margin-bottom: 0.8rem;
}

.input-field-wrapper {
    flex: 1;
    position: relative;
}

.cyber-text-input {
    width: 100%;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 0.8rem 1.2rem;
    color: var(--cyber-text);
    font-family: inherit;
    font-size: 1rem;
    resize: none;
    outline: none;
    transition: all 0.3s ease;
    min-height: 44px;
    max-height: 120px;
}

.cyber-text-input:focus {
    border-color: var(--cyber-primary);
    box-shadow: 0 0 15px rgba(13, 139, 255, 0.2);
}

.input-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.cyber-send-button,
.cyber-stop-button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, var(--cyber-primary), var(--cyber-accent));
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.cyber-send-button:hover,
.cyber-stop-button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(13, 139, 255, 0.3);
}

.cyber-stop-button {
    background: linear-gradient(135deg, #ff5f57, #ff2e2e);
}

/* Comandos rápidos */
.quick-commands {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
}

.command-button {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    padding: 0.6rem 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: var(--cyber-text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
}

.command-button:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--cyber-text);
}

.command-button i {
    font-size: 1rem;
}

/* Animaciones */
@keyframes message-appear {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slide-up {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes typing-bounce {
    0%, 80%, 100% {
        transform: translateY(0);
        opacity: 0.5;
    }
    40% {
        transform: translateY(-5px);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Mejoras específicas para móviles */
@media (max-width: 768px) {
    .cyber-chat-container {
        height: 100vh;
    }
    
    .chat-terminal-header {
        padding: 0.8rem;
    }
    
    .cyber-chat-title {
        font-size: 1.1rem;
    }
    
    .terminal-controls {
        display: none;
    }
    
    .cyber-messages-container {
        padding: 0.8rem;
        gap: 0.8rem;
    }
    
    .message-avatar,
    .system-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
    
    .message-content {
        max-width: 82%;
    }
    
    .message-bubble {
        padding: 0.7rem 0.9rem;
    }
    
    .message-sender {
        font-size: 0.75rem;
    }
    
    .message-text {
        font-size: 0.9rem;
    }
    
    .cyber-input-panel {
        padding: 0.8rem;
    }
    
    .cyber-text-input {
        padding: 0.7rem 1rem;
        font-size: 16px; /* Previene zoom en iOS */
        min-height: 42px;
    }
    
    .cyber-send-button,
    .cyber-stop-button {
        width: 42px;
        height: 42px;
    }
    
    .quick-commands {
        overflow-x: auto;
        padding-bottom: 0.2rem;
        justify-content: flex-start;
    }
    
    .command-button {
        flex: 0 0 auto;
        min-width: 70px;
        font-size: 0.75rem;
    }
    
    .command-button i {
        font-size: 0.9rem;
    }
}

/* Soporte para dispositivos muy pequeños */
@media (max-width: 360px) {
    .cyber-chat-title {
        font-size: 1rem;
    }
    
    .status-text {
        display: none;
    }
    
    .message-avatar,
    .system-avatar {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
    }
    
    .message-content {
        max-width: 80%;
    }
    
    .cyber-text-input {
        padding: 0.6rem 0.9rem;
    }
    
    .command-button {
        min-width: 65px;
        font-size: 0.7rem;
        padding: 0.5rem 0.4rem;
    }
}

/* Mejoras de accesibilidad */
@media (prefers-reduced-motion: reduce) {
    .message-user,
    .message-bot,
    .message-system,
    .cyber-typing-indicator {
        animation: none;
    }
    
    .typing-dots span {
        animation: none;
    }
    
    .status-indicator {
        animation: none;
    }
}

/* Scrollbar personalizado */
.cyber-messages-container::-webkit-scrollbar {
    width: 6px;
}

.cyber-messages-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.cyber-messages-container::-webkit-scrollbar-thumb {
    background: var(--cyber-primary);
    border-radius: 3px;
}

.cyber-messages-container::-webkit-scrollbar-thumb:hover {
    background: var(--cyber-accent);
}
</style>
{% endblock %}